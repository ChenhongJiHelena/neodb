
{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="{{ site_name }} - 联邦宇宙书影音游戏标注平台">
    <meta name="description" property="og:description" content="NeoDB致力于为联邦宇宙居民提供一个自由、开放、互联的书籍、电影、音乐和游戏收藏评论空间">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'img/logo_square.jpg' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/skeleton-css@2.0.4/css/normalize.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.min.css">
    <link rel="stylesheet" href="{% static 'css/boofilsic_edit.css' %}">
    <link rel="stylesheet" href="{% static 'css/boofilsic_box.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <title>{{ site_name }} - {% trans '登录' %}</title>
</head>
<body>
    <style>
        select {
            padding-left: 16px;
            padding-right: 16px;
            margin-bottom: 20px;;
        }
    </style>
    <div id="loginBox" class="box">

            <img src="{% static 'img/logo.svg' %}" class="logo" alt="boofilsic logo">
        
        <div id="loginButton">
            
            
            {% if user.is_authenticated %}
            <a href="{% url 'common:home' %}" class="button">{% trans '前往我的主页' %}</a>
            {% elif allow_any_site %}
            <form action="/users/connect" onsubmit="return /^(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,})$/.test($('#domain').val())">
            <input type="search" name="domain" id="domain" placeholder="实例域名，如mastodon.social (不含@)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <input type='submit' value="{% trans '授权登录' %}" />
            </form>
            {% else %}            
            <select name="sites" id="sitesSelect" placeholder="test">
                {% for site in sites %}
                <option value="{{ site.domain_name }}" data-client-id="{{ site.client_id }}">@{{ site.domain_name }}</option>
                {% endfor %}
            </select>
            <button name='login'>{% trans '授权登录' %}</button>
            <a target="_blank" href="https://about.neodb.social/doc/howto/">{% trans '了解更多' %}</a>
            {% endif %}
                
        </div>

    </div>
    {% if not user.is_authenticated and not allow_any_site %}
    
    
    <script>
        {% if selected_site %}
        $("#sitesSelect").val("{{ selected_site }}");
        {% else %}
        $("#sitesSelect").val($("#sitesSelect option:first").val());
        {% endif %}
        $("button[name=login]").click(function(e) {
            e.preventDefault();
            let selected =  $("#sitesSelect").find(":selected");
            let client_id = selected.data("client-id");
            let domain = selected.val();

            Cookies.set('mastodon_domain', domain);
            location.href = "https://" + domain + "/oauth/authorize?client_id=" + client_id + 
                "&scope={{ scope }}&redirect_uri={{ request.scheme }}://{{ request.get_host }}{% url 'users:OAuth2_login' %}" +
                "&response_type=code";
        });
    </script>
    {% endif %}
</body>
</html>
